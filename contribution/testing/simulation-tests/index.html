<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-contribution/testing/simulation-tests" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Lodestar Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://chainsafe.github.io/lodestar/contribution/testing/simulation-tests"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Simulation Tests | Lodestar"><meta data-rh="true" name="description" content="&quot;Sim&quot; testing for Lodestar is the most comprehensive, and complex, testing that is run. The goal is to fully simulate a testnet and to actuate the code in a way that closely mimics what will happen when turning on Lodestar in the wild. This is a very complex task and requires a lot of moving parts to work together. The following sections will describe the various components and how they work together."><meta data-rh="true" property="og:description" content="&quot;Sim&quot; testing for Lodestar is the most comprehensive, and complex, testing that is run. The goal is to fully simulate a testnet and to actuate the code in a way that closely mimics what will happen when turning on Lodestar in the wild. This is a very complex task and requires a lot of moving parts to work together. The following sections will describe the various components and how they work together."><link data-rh="true" rel="icon" href="/lodestar/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://chainsafe.github.io/lodestar/contribution/testing/simulation-tests"><link data-rh="true" rel="alternate" href="https://chainsafe.github.io/lodestar/contribution/testing/simulation-tests" hreflang="en"><link data-rh="true" rel="alternate" href="https://chainsafe.github.io/lodestar/contribution/testing/simulation-tests" hreflang="x-default"><script src="https://plausible.io/js/script.js" defer="defer" data-domain="chainsafe.github.io/lodestar"></script><link rel="stylesheet" href="/lodestar/assets/css/styles.bee45100.css">
<script src="/lodestar/assets/js/runtime~main.deb181d4.js" defer="defer"></script>
<script src="/lodestar/assets/js/main.fc6c0fe7.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/lodestar/"><div class="navbar__logo"><img src="/lodestar/images/logo.png" alt="Lodestar Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/lodestar/images/logo.png" alt="Lodestar Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Lodestar Documentation</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ChainSafe/lodestar" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lodestar/">Home</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/lodestar/run/getting-started/quick-start">Run A Node</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/lodestar/libraries/lightclient-prover/lightclient-cli">Developer Tools</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/libraries/lightclient-prover/lightclient-cli">Lodestar Light Client</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/libraries/lightclient-prover/prover">Lodestar Light Prover</a></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lodestar/supporting-libraries/">Supporting Libraries</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/lodestar/contribution/advanced-topics/setting-up-a-testnet">Contributing</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" tabindex="0" href="/lodestar/contribution/advanced-topics/setting-up-a-testnet">Advanced Topics</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/advanced-topics/setting-up-a-testnet">Setting Up a Testnet</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/depgraph">Dependency Graph</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/lodestar/contribution/tools/debugging">Development Tools</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/lodestar/contribution/testing/">Testing</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/testing/">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/testing/end-to-end-tests">End-To-End Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/testing/integration-tests">Integration Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/testing/performance-tests">Performance Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/lodestar/contribution/testing/simulation-tests">Simulation Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/lodestar/contribution/testing/spec-tests">Specification Tests</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lodestar/faqs">Frequently Asked Questions</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/lodestar/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Contributing</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Testing</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Simulation Tests</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Simulation Tests</h1>
<p>&quot;Sim&quot; testing for Lodestar is the most comprehensive, and complex, testing that is run. The goal is to fully simulate a testnet and to actuate the code in a way that closely mimics what will happen when turning on Lodestar in the wild. This is a very complex task and requires a lot of moving parts to work together. The following sections will describe the various components and how they work together.</p>
<p>At a very high level, simulation testing will setup a testnet from genesis and let proceed through &quot;normal&quot; execution exactly as the nodes would under production circumstances. To get feedback there are regular checks along the way to asses how the testnet nodes are working. These &quot;assertions&quot; can be added and removed at will to allow developers to check for specific conditions in a tightly controlled, reproducible, environment to get high quality and actionable feedback on how Lodestar performs. The end goal of these tests is to to run a full Lodestar client in an environment that is as close to what an end user would experience.</p>
<p>These tests usually setup full testnets with multiple consensus clients and their paired execution node. In many instance we are looking to just exercise the Lodestar code but there are some places where there is also testing to see how Lodestar works in relation to the other consensus clients, like Lighthouse. As you can imagine, there is quite a bit of machinery that is responsible for setting up and managing the simulations and assertions. This section will help to go over those bits and pieces. Many, but not all, of these classes can be found in <code>packages/cli/test/utils/simulation</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-sim-tests">Running Sim Tests<a class="hash-link" aria-label="Direct link to Running Sim Tests" title="Direct link to Running Sim Tests" href="/lodestar/contribution/testing/simulation-tests#running-sim-tests">​</a></h2>
<p>There are a number of sim tests that are available and each has a slightly different purpose. All are run by CI and must pass for a PR to be valid for merging. Most tests require a couple of environment variables to be set.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="environment-variables">Environment Variables<a class="hash-link" aria-label="Direct link to Environment Variables" title="Direct link to Environment Variables" href="/lodestar/contribution/testing/simulation-tests#environment-variables">​</a></h3>
<p>To see what typical values for these are check out the <code>.env.test</code> file in the root directory.</p>
<ul>
<li><code>GETH_DOCKER_IMAGE</code>: The geth docker image that will be used</li>
<li><code>NETHERMIND_IMAGE</code>: The nethermind docker image that will be used</li>
<li><code>LIGHTHOUSE_IMAGE</code>: The lighthouse docker image that will be used</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testsimmultifork"><code>test:sim:multifork</code><a class="hash-link" aria-label="Direct link to testsimmultifork" title="Direct link to testsimmultifork" href="/lodestar/contribution/testing/simulation-tests#testsimmultifork">​</a></h3>
<p>The multi-fork sim test checks most of the functionality Lodestar provides. Is verifies that Lodestar is capable of peering, moving through all of the forks and using various sync methods in a testnet environment. Lodestar is tested with both Geth and Nethermind as the execution client. It also checks a Lighthouse/Geth node for cross client compatibility.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">yarn</span><span class="token plain"> workspace @chainsafe/lodestar test:sim:multifork</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testsimendpoints"><code>test:sim:endpoints</code><a class="hash-link" aria-label="Direct link to testsimendpoints" title="Direct link to testsimendpoints" href="/lodestar/contribution/testing/simulation-tests#testsimendpoints">​</a></h3>
<p>This tests that various endpoints of the beacon node and validator client are working as expected.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">yarn</span><span class="token plain"> workspace @chainsafe/lodestar test:sim:endpoints</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testsimdeneb"><code>test:sim:deneb</code><a class="hash-link" aria-label="Direct link to testsimdeneb" title="Direct link to testsimdeneb" href="/lodestar/contribution/testing/simulation-tests#testsimdeneb">​</a></h3>
<p>This test is still included in our CI but is no longer as important as it once was. Lodestar is often the first client to implement new features and this test was created before geth was upgraded with the features required to support the Deneb fork. To test that Lodestar was ready this test uses mocked geth instances. It is left as a placeholder for when the next fork comes along that requires a similar approach.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="testsimmixedcleint"><code>test:sim:mixedcleint</code><a class="hash-link" aria-label="Direct link to testsimmixedcleint" title="Direct link to testsimmixedcleint" href="/lodestar/contribution/testing/simulation-tests#testsimmixedcleint">​</a></h3>
<p>Checks that Lodestar is compatible with other consensus validators and vice-versa. All tests use Geth as the EL.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">yarn</span><span class="token plain"> workspace @chainsafe/lodestar test:sim:mixedclient</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sim-test-infrastructure">Sim Test Infrastructure<a class="hash-link" aria-label="Direct link to Sim Test Infrastructure" title="Direct link to Sim Test Infrastructure" href="/lodestar/contribution/testing/simulation-tests#sim-test-infrastructure">​</a></h2>
<p>When setting up and running the simulations, interactions with the nodes is through the published node API&#x27;s. All functionality is actuated via http request and by &quot;plugging in&quot; this way it is possible to run the nodes in a stand-alone fashion, as they would be run in production, but to still achieve a tightly monitored and controlled environment. If code needs to be executed on a &quot;class by class&quot; basis or with mocking involved then the test is not a simulation test and would fall into one of the other testing categories. See the <a href="/lodestar/contribution/testing/">Testing Overview</a> page for more information on the other types of tests available for Lodestar.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulation-environment">Simulation Environment<a class="hash-link" aria-label="Direct link to Simulation Environment" title="Direct link to Simulation Environment" href="/lodestar/contribution/testing/simulation-tests#simulation-environment">​</a></h3>
<p>The simulation environment has many pieces and those are orchestrated by the <code>SimulationEnvironment</code> class. The testnet nodes will be run as a mixture of Docker containers and bare metal code execution via Node.js. In order to monitor the various clients there is a <code>SimulationTracker</code> that&#x27;s primary function is to <code>register</code> assertions that will track and gauge how the nodes are doing during the simulation. See the section on <a href="/lodestar/contribution/testing/simulation-tests#simulation-assertions">Simulation Assertions</a> below for more information on them. There is an <code>EpochClock</code> that has helper functions related to timing of slots and epochs and there is also a <code>Runner</code> that will help to start/stop the various Docker container and spawn the Node.js child processes as necessary.</p>
<p>The <code>SimulationEnvironment</code> is the orchestrator for all the various functions to great the test net and start it from genesis. It is also how the various forks are configured to exercise code through various fork transitions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulation-assertions">Simulation Assertions<a class="hash-link" aria-label="Direct link to Simulation Assertions" title="Direct link to Simulation Assertions" href="/lodestar/contribution/testing/simulation-tests#simulation-assertions">​</a></h3>
<p>These are the secret sauce for making the simulation tests meaningful. There are several predefined assertions that can be added to a simulation tracker and one can also create custom assertions and add them to the environment. Assertions can be added per slot, per epoch, per fork or per node. They can even be added to check conditions across nodes.</p>
<p>Assertions are added to the <code>SimulationTracker</code> with the <code>register</code> method and the tracker follows the environment to make sure that assertions are run at the appropriate times, and on the correct targets.</p>
<p>Assertions are implemented via API calls to the various targets and meta from the API calls is stored and used to assert that the desired conditions were met. Any information that can be retrieved via API call can be added to the assertion <code>stores</code> for validation, and validations can be asserted at a specific time or on an interval.</p>
<p>There are a number of assertions that are added to simulations by default. They are:</p>
<ul>
<li><code>inclusionDelayAssertion</code></li>
<li><code>attestationsCountAssertion</code></li>
<li><code>attestationParticipationAssertion</code></li>
<li><code>connectedPeerCountAssertion</code></li>
<li><code>finalizedAssertion</code></li>
<li><code>headAssertion</code></li>
<li><code>missedBlocksAssertion</code></li>
<li><code>syncCommitteeParticipationAssertion</code></li>
</ul>
<p>Because of the flexibility, and complexity, there is a section specifically for how to create custom assertions below. See <a href="/lodestar/contribution/testing/simulation-tests#custom-assertions">custom assertions</a> for more info.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="custom-assertions">Custom Assertions<a class="hash-link" aria-label="Direct link to Custom Assertions" title="Direct link to Custom Assertions" href="/lodestar/contribution/testing/simulation-tests#custom-assertions">​</a></h3>
<p>Check back soon for more information on how to create custom assertions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulation-reports">Simulation Reports<a class="hash-link" aria-label="Direct link to Simulation Reports" title="Direct link to Simulation Reports" href="/lodestar/contribution/testing/simulation-tests#simulation-reports">​</a></h3>
<p>Sim tests that are run using the simulation framework output a table of information to the console. The table summarizes the state of all of the nodes and the network at each slot.</p>
<p>Here is an example of the table and how to interpret it:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#000000;background-color:#ffffff"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">┼────────────────────────────────────────── ───────────────────────────────────────────────────────┼</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ fork       │ eph   │ slot │ </span><span class="token function" style="color:rgb(0, 0, 255)">head</span><span class="token plain">       │ finzed   │ peers    │ attCount │ incDelay │ errors     │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">┼─────────────────────────────────────────────────────────────────────────────────────────────────┼</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ capella    │ </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">/0   │ </span><span class="token number" style="color:rgb(9, 134, 88)">72</span><span class="token plain">   │ 0x95c4</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">   │ </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">        │ </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">1.00</span><span class="token plain">     │ </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">          │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ capella    │ </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">/1   │ </span><span class="token number" style="color:rgb(9, 134, 88)">73</span><span class="token plain">   │ 0x9dfc</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">   │ </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">        │ </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">1.00</span><span class="token plain">     │ </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">          │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ capella    │ </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">/2   │ </span><span class="token number" style="color:rgb(9, 134, 88)">74</span><span class="token plain">   │ 0xdf3f</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">   │ </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">        │ </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">1.00</span><span class="token plain">     │ </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">          │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ capella    │ </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">/3   │ </span><span class="token number" style="color:rgb(9, 134, 88)">75</span><span class="token plain">   │ 0xbeae</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">   │ </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">        │ </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">1.00</span><span class="token plain">     │ </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">          │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ capella    │ </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">/4   │ </span><span class="token number" style="color:rgb(9, 134, 88)">76</span><span class="token plain">   │ 0x15fa</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">   │ </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token plain">        │ </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">1.00</span><span class="token plain">     │ </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">          │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ capella    │ </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">/5   │ </span><span class="token number" style="color:rgb(9, 134, 88)">77</span><span class="token plain">   │ 0xf8ff</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">   │ </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">2,3</span><span class="token plain">,3,2  │ </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">1.00</span><span class="token plain">     │ </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">          │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ capella    │ </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">/6   │ </span><span class="token number" style="color:rgb(9, 134, 88)">78</span><span class="token plain">   │ 0x8199</span><span class="token punctuation" style="color:rgb(4, 81, 165)">..</span><span class="token plain">   │ </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">2,3</span><span class="token plain">,3,2  │ </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">1.20</span><span class="token plain">     │ </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token plain">          │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ capella    │ </span><span class="token number" style="color:rgb(9, 134, 88)">9</span><span class="token plain">/7   │ </span><span class="token number" style="color:rgb(9, 134, 88)">79</span><span class="token plain">   │ different  │ </span><span class="token number" style="color:rgb(9, 134, 88)">56</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">2,3</span><span class="token plain">,3,2  │ </span><span class="token number" style="color:rgb(9, 134, 88)">16</span><span class="token plain">       │ </span><span class="token number" style="color:rgb(9, 134, 88)">1.50</span><span class="token plain">     │ </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain">          │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">┼─────────────────────────────────────────────────────────────────────────────────────────────────┼</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ Att Participation: H: </span><span class="token number" style="color:rgb(9, 134, 88)">0.75</span><span class="token plain">, S: </span><span class="token number" style="color:rgb(9, 134, 88)">1.00</span><span class="token plain">, T: </span><span class="token number" style="color:rgb(9, 134, 88)">0.75</span><span class="token plain"> - SC Participation: </span><span class="token number" style="color:rgb(9, 134, 88)">1.00</span><span class="token plain">                           │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">┼─────────────────────────────────────────────────────────────────────────────────────────────────┼</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="slot-information">Slot Information<a class="hash-link" aria-label="Direct link to Slot Information" title="Direct link to Slot Information" href="/lodestar/contribution/testing/simulation-tests#slot-information">​</a></h4>
<ul>
<li><code>fork</code>: shows what fork is currently being tested</li>
<li><code>eph</code>: During simulation tests the Lodestar repo is setup to use 8 slot per epoch so what is shown is the epoch number and the slot number within that epoch as <code>epoch/slot</code></li>
<li><code>slot</code>: The slot number that is currently being processed</li>
<li><code>head</code>: If all clients have the same head the first couple of bytes of the hash are shown. If all clients do not have the same head <code>different</code> is reported.</li>
<li><code>finzed</code>: Shows the number of the last finalized slot</li>
<li><code>peers</code>: The number of peers that each node is connected to. If all have the same number then only a single value is shown. If they do not have the same number of peers count for each node is reported in a comma-separated list</li>
<li><code>attCount</code>: The number of attestations that the node has seen.</li>
<li><code>incDelay</code>: The average number of slots inclusion delay was experienced for the attestations. Often attestations for the current head arrive more than one slot behind and this value tracks that</li>
<li><code>errors</code>: The number of errors that were encountered during the slot</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="epoch-information">Epoch Information<a class="hash-link" aria-label="Direct link to Epoch Information" title="Direct link to Epoch Information" href="/lodestar/contribution/testing/simulation-tests#epoch-information">​</a></h4>
<ul>
<li><code>H</code>: The percentage of nodes, at epoch transition, that voted for the head block</li>
<li><code>S</code>: The percentage of nodes, at epoch transition, that voted for the source block</li>
<li><code>T</code>: The percentage of nodes, at epoch transition, that voted for the target block</li>
<li><code>SC Participation</code>: The sync committee participation rate</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulation-logging">Simulation Logging<a class="hash-link" aria-label="Direct link to Simulation Logging" title="Direct link to Simulation Logging" href="/lodestar/contribution/testing/simulation-tests#simulation-logging">​</a></h3>
<p>The simulation environment will capture all of the logs from all nodes that are running. The logs can be found in the <code>packages/cli/test-logs</code> directory. The logs are named with the following convention:</p>
<p><code>&lt;PURPOSE&gt;-&lt;TYPE&gt;_&lt;CLIENT&gt;.log</code></p>
<p>Some examples are:</p>
<ul>
<li><code>node-1-beacon_lodestar.log</code>: The is the first node in the simulation. It is the consensus layer. It is running the lodestar validator client.</li>
<li><code>range-sync-execution_geth.log</code>: This is the node that was added to test pulling history in range sync mode. It was the execution layer and was running the geth execution client.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ChainSafe/lodestar/tree/unstable/docs/pages/contribution/testing/simulation-tests.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/lodestar/contribution/testing/performance-tests"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Performance Tests</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/lodestar/contribution/testing/spec-tests"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Specification Tests</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#running-sim-tests">Running Sim Tests</a><ul><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#environment-variables">Environment Variables</a></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#testsimmultifork"><code>test:sim:multifork</code></a></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#testsimendpoints"><code>test:sim:endpoints</code></a></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#testsimdeneb"><code>test:sim:deneb</code></a></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#testsimmixedcleint"><code>test:sim:mixedcleint</code></a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#sim-test-infrastructure">Sim Test Infrastructure</a><ul><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#simulation-environment">Simulation Environment</a></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#simulation-assertions">Simulation Assertions</a></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#custom-assertions">Custom Assertions</a></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#simulation-reports">Simulation Reports</a><ul><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#slot-information">Slot Information</a></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#epoch-information">Epoch Information</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/lodestar/contribution/testing/simulation-tests#simulation-logging">Simulation Logging</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/lodestar/introduction">Introduction</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.com/invite/yjyvFRP" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/lodestar_eth" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 ChainSafe, Inc.</div></div></div></footer></div>
</body>
</html>